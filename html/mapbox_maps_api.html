<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mapbox</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <script src="../js/keys.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 50%}
  </style>
</head>
<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

<div id="map"></div>

<script>
  // TO MAKE THE MAP APPEAR YOU MUST
  // ADD YOUR ACCESS TOKEN FROM
  // https://account.mapbox.com
  mapboxgl.accessToken = MAPBOX_API_KEY;
  const map = new mapboxgl.Map({
    container: 'map',
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-98.4916, 29.4252],
    zoom: 9
  });

  /* Given a query in the form "lng, lat" or "lat, lng"
   * returns the matching geographic coordinate(s)
   * as search results in carmen geojson format,
   * https://github.com/mapbox/carmen/blob/master/carmen-geojson.md */
  const coordinatesGeocoder = function (query) {
    // Match anything which looks like
    // decimal degrees coordinate pair.
    const matches = query.match(
            /^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
    );
    if (!matches) {
      return null;
    }

    function coordinateFeature(lng, lat) {
      return {
        center: [lng, lat],
        geometry: {
          type: 'Point',
          coordinates: [lng, lat]
        },
        place_name: 'Lat: ' + lat + ' Lng: ' + lng,
        place_type: ['coordinate'],
        properties: {},
        type: 'Feature'
      };
    }

    const coord1 = Number(matches[1]);
    const coord2 = Number(matches[2]);
    const geocodes = [];

    if (coord1 < -90 || coord1 > 90) {
      // must be lng, lat
      geocodes.push(coordinateFeature(coord1, coord2));
    }

    if (coord2 < -90 || coord2 > 90) {
      // must be lat, lng
      geocodes.push(coordinateFeature(coord2, coord1));
    }

    if (geocodes.length === 0) {
      // else could be either lng, lat or lat, lng
      geocodes.push(coordinateFeature(coord1, coord2));
      geocodes.push(coordinateFeature(coord2, coord1));
    }

    return geocodes;
  };

  // Add the control to the map.
  map.addControl(
          new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            localGeocoder: coordinatesGeocoder,
            zoom: 4,
            placeholder: 'Try: -40, 170',
            mapboxgl: mapboxgl,
            reverseGeocode: true
          })
  );
  function geocode(search, token) {
    var baseUrl = 'https://api.mapbox.com';
    var endPoint = '/geocoding/v5/mapbox.places/';
    return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
            .then(function(res) {
              return res.json();
              // to get all the data from the request, comment out the following three lines...
            }).then(function(data) {
              return data.features[0].center;
            });
  }
  var accessToken = MAPBOX_API_KEY;


  let r1Info = {
    address: "John The Greek",
    popupHTML: "<h3> John The Greek</h3>" +
            "<b> Greek food made fresh everyday </b>"+"<p>My favriote meal there is the lamb plate.</p>"
  };
  let r2Info = {
    address: "Schilo's",
    popupHTML: "<h3> Schilo's</h3>"+ "<b> The oldest resturaunt in San Antonio </b>"+"<p>The homemade rootbeer is best in town.</p>"
  };
  let r3Info = {
    address: "Max & Louie’s",
    popupHTML: "<h3> Max & Louie’s </h3>"+"<b> A classic new york style diner food  </b>"+"<p>I prefer the old fashion chili with an english muffin.</p>"
  };
  function placeMarkerAndPopup(info, token, map) {
    geocode(info.address, token).then(function(coordinates) {
      var popup = new mapboxgl.Popup()
              .setHTML(info.popupHTML);
      var marker = new mapboxgl.Marker()
              .setLngLat(coordinates)
              .addTo(map)
              .setPopup(popup);

    });
  }
  placeMarkerAndPopup(r1Info, accessToken , map);
  placeMarkerAndPopup(r2Info, accessToken , map);
  placeMarkerAndPopup(r3Info, accessToken , map);

  map.addControl(new mapboxgl.NavigationControl());

  map.on('load', () => {
// Load an image from an external URL.
    map.loadImage(
            'https://docs.mapbox.com/mapbox-gl-js/assets/cat.png',
            (error, image) => {
              if (error) throw error;

// Add the image to the map style.
              map.addImage('cat', image);

// Add a data source containing one point feature.
              map.addSource('point', {
                'type': 'geojson',
                'data': {
                  'type': 'FeatureCollection',
                  'features': [
                    {
                      'type': 'Feature',
                      'geometry': {
                        'type': 'Point',
                        'coordinates': [29.9792, 31.1342]
                      }
                    }
                  ]
                }
              });

// Add a layer to use the image to represent the data.
              map.addLayer({
                'id': 'points',
                'type': 'symbol',
                'source': 'point', // reference the data source
                'layout': {
                  'icon-image': 'cat', // reference the image
                  'icon-size': 0.2
                }
              });
            }
    );
  });

  const size = 200;

  // This implements `StyleImageInterface`
  // to draw a pulsing dot icon on the map.
  const pulsingDot = {
    width: size,
    height: size,
    data: new Uint8Array(size * size * 4),

// When the layer is added to the map,
// get the rendering context for the map canvas.
    onAdd: function () {
      const canvas = document.createElement('canvas');
      canvas.width = this.width;
      canvas.height = this.height;
      this.context = canvas.getContext('2d');
    },

// Call once before every frame where the icon will be used.
    render: function () {
      const duration = 1000;
      const t = (performance.now() % duration) / duration;

      const radius = (size / 2) * 0.3;
      const outerRadius = (size / 2) * 0.7 * t + radius;
      const context = this.context;

// Draw the outer circle.
      context.clearRect(0, 0, this.width, this.height);
      context.beginPath();
      context.arc(
              this.width / 2,
              this.height / 2,
              outerRadius,
              0,
              Math.PI * 2
      );
      context.fillStyle = `rgba(255, 200, 200, ${1 - t})`;
      context.fill();

// Draw the inner circle.
      context.beginPath();
      context.arc(
              this.width / 2,
              this.height / 2,
              radius,
              0,
              Math.PI * 2
      );
      context.fillStyle = 'rgba(255, 100, 100, 1)';
      context.strokeStyle = 'white';
      context.lineWidth = 2 + 4 * (1 - t);
      context.fill();
      context.stroke();

// Update this image's data with data from the canvas.
      this.data = context.getImageData(
              0,
              0,
              this.width,
              this.height
      ).data;

// Continuously repaint the map, resulting
// in the smooth animation of the dot.
      map.triggerRepaint();

// Return `true` to let the map know that the image was updated.
      return true;
    }
  };


</script>

</body>
</html>